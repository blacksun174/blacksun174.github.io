---
layout: post
title:  "データ分析基盤をリリースするタイミング"
date:   2021-06-28 10:15:00 +0900
categories: dataplatform, deploy, release
---
# データ分析基盤をリリースするタイミング
データ分析基盤では定時集計が結構あって、集計中にリリースをすると集計処理が失敗することがあるため、
なるべき集計処理中にリリースをしない方がいい。
これは使っているシステムにもよりますが、私が使っているdigdagなら集計中にETLスクリプトをリリースしても影響はないです。
digdagは古いスクリプトを使って集計処理を続けるためです。
しかし、AWS Glueだと、Glue jobからS3上にあるETLスクリプトをDownloadしてくるので、集計中にETLスクリプトをリリースすると、場合によっては
新しいスクリプトか、古いスクリプトかが実行されるか分かりません。複数のジョブがある中で、どっちのスクリプトを実行するか分かりません。
そのため、AWS Glueの場合は定時集計を避けてリリースした方がいい。
digdagのインフラ（コンテナなど）を更新する場合は、どのタイミングでコンテナが削除され更新されるか分からないため、この場合もやはり定期集計を避けた方がいい。
またインフラを更新するまでは集計をしない方が良い。新しいETLスクリプトを実行するのに、古いコンテナが残っていてそこで実行されると、集計処理が失敗するためです。
まあ、インフラ更新とETLスクリプトの変更を別々のプルリクに分けて、インフラの変更を先にリリースすれば、この問題を解決できるかもしれません。
